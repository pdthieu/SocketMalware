import time
import socket
import os, signal
from typing import List
from pynput import keyboard
from win32com.client.selecttlb import FLAG_RESTRICTED
import wmi
from dotenv import load_dotenv
import subprocess
import pyscreenshot as ImageGrab
from pynput.keyboard import Listener
import threading

load_dotenv()
SERVER_HOST = os.getenv('SERVER_HOST')
SERVER_PORT = os.getenv('SERVER_PORT')

def sendScreenShotImage(conn):
    im = open('screenshot.png', 'rb')
    imBytes = im.read()
    conn.sendall(imBytes)
    pass

def getProcessRunning():
    f = wmi.WMI()
    return f.Win32_process()

def getListRunningWinodws():
    cmd = 'powershell "gps | where {$_.MainWindowTitle } | select Description,Id'
    ret = []
    proc = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)
    for line in proc.stdout:
        if not line.decode()[0].isspace():
            temp = (line.decode().rstrip())
            ret.append(temp)
    ret = ret[2:]
    return ret

def processKeyPress(key):
    print(key)

def processKeyRelease(key):
    if key == keyboard.Key.esc:
        return False

def keyHook():
    with Listener(on_press=processKeyPress, on_release=processKeyRelease) as listener:
        listener.join()

def processRequest(request, conn):
    print(request)
    if request == 'screenshot':
        im = ImageGrab.grab()
        im.save('screenshot.png')
        sendScreenShotImage(conn)
    
    if request == 'process running':
        listProcess = getProcessRunning()
        for process in listProcess:
            temp = (f"{process.ProcessId:<10} {process.Name}")
            conn.sendall(bytes(temp, 'utf8'))
        conn.sendall(b'done')

    if request == 'kill process':
        conn.sendall(b'Received request kill process')
        data = conn.recv(1024)
        processId = data.decode('utf8')
        os.kill(int(data), signal.SIGTERM)

    if request == 'application running':
        temp = getListRunningWinodws()
        for line in temp:
            time.sleep(0.1)
            conn.sendall(bytes(line, 'utf8'))
        conn.sendall(b'done')

    if request == 'start application':
        conn.sendall(b'application name')
        data = conn.recv(1024)
        print(data.decode('utf8'))
        res = os.system('start ' + data.decode('utf8'))
        conn.sendall(bytes(str(res), 'utf8'))

    if request == 'key hook':
        keyHookThread = threading.Thread(target=keyHook)
        keyHookThread.start()
        print('key hook starting')
        pass

if __name__ == '__main__':
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind((SERVER_HOST, int(SERVER_PORT)))
        s.listen()
        while True:
            conn, addr = s.accept()
            with conn:
                print('Connected by: ', addr)
                while True:
                    request = conn.recv(1024)
                    if not request:
                        break
                    processRequest(request.decode('utf8'), conn)
                conn.close()